name: Deploy to Render

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set image tag
      id: set-tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=latest" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
      run: |
        echo "Deploying image sripadha112/line_application:${IMAGE_TAG} to Render..."
        
        # Trigger Render deployment via API
        curl -X POST \
          "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
          -H "Authorization: Bearer ${RENDER_API_KEY}" \
          -H "Content-Type: application/json" \
          -d '{
            "clearCache": "clear"
          }'
          
        echo "Render deployment triggered successfully!"
        
    - name: Wait for deployment
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "Waiting for deployment to complete..."
        
        # Poll deployment status
        for i in {1..30}; do
          STATUS=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}" | \
            jq -r '.service.serviceDetails.buildAndDeploy.buildStatus // "unknown"')
            
          echo "Deployment status: $STATUS"
          
          if [ "$STATUS" = "live" ]; then
            echo "✅ Deployment completed successfully!"
            exit 0
          elif [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "deploy_failed" ]; then
            echo "❌ Deployment failed with status: $STATUS"
            exit 1
          fi
          
          sleep 30
        done
        
        echo "⚠️ Deployment status check timed out"
        exit 1